--  ********************************************************************** 
--  Note: This rebuild script is not meant to be used when a possibility * 
--        exists that someone might try to access the table while it is  * 
--        being rebuilt!                                                 * 
--                                                                       * 
--        Locks are released when the first DDL, COMMIT or ROLLBACK is   * 
--        performed, so adding a "Lock table" command at the top of this * 
--        script will not prevent others from accessing the table for    * 
--        the duration of the script.                                    * 
--                                                                       * 
--   One more important note:                                            * 
--        This script will cause the catalog in replicated environments  * 
--        to become out of sync.                                         * 
--  ********************************************************************** 

--  Table Rebuild script generated by TOAD  
--  
--  Original table: T_PERSONAL 
--  Backup of table: T_PERSONAL_X 
--  Date: 2009-5-21 14:36:54 
--  
SET LINESIZE 200
SET ECHO OFF
SET VERIFY OFF
SET HEADING OFF
--  
--  Make backup copy of original table 
ALTER TABLE T_PERSONAL RENAME TO T_PERSONAL_X ; 
  
--  Drop FKey constraint from T_RUNNING_BUSPARK 
ALTER TABLE T_RUNNING_BUSPARK DROP CONSTRAINT FK_BUSPARK_ATTEMPER ; 
  
--  Drop FKey constraint from T_USEUP_ELE_TMP 
ALTER TABLE T_USEUP_ELE_TMP DROP CONSTRAINT FK_ELETMP_CHCKPSN ; 
  
--  Drop FKey constraint from T_USEUP_ELE_TMP 
ALTER TABLE T_USEUP_ELE_TMP DROP CONSTRAINT FK_ELETMP_DOPSN ; 
  
--  Drop FKey constraint from T_USEUP_ELE_TMP 
ALTER TABLE T_USEUP_ELE_TMP DROP CONSTRAINT FK_ELE_INPUTPSN ; 
  
--  Drop FKey constraint from T_RUNNING_LINE 
ALTER TABLE T_RUNNING_LINE DROP CONSTRAINT FK_LINE_ATTEMPER ; 
  
--  Drop FKey constraint from T_RUNNING_LINE 
ALTER TABLE T_RUNNING_LINE DROP CONSTRAINT FK_LINE_RESPONSOR ; 
  
--  Drop FKey constraint from T_OILCARD 
ALTER TABLE T_OILCARD DROP CONSTRAINT FK_OILCARDDRIVER ; 
  
--  Drop FKey constraint from T_OILCARD_INPUT 
ALTER TABLE T_OILCARD_INPUT DROP CONSTRAINT FK_OILCARDINPUTPERSONAL ; 
  
--  Drop FKey constraint from T_OILCARD_OUTPUT 
ALTER TABLE T_OILCARD_OUTPUT DROP CONSTRAINT FK_OILCARDOUTPUTDRIVER ; 
  
--  Drop FKey constraint from T_OILCARD_OUTPUT 
ALTER TABLE T_OILCARD_OUTPUT DROP CONSTRAINT FK_OILCARDOUTPUTINPUTER ; 
  
--  Drop FKey constraint from T_ONLINE 
ALTER TABLE T_ONLINE DROP CONSTRAINT FK_ONLINEDOWNINSTALLOR ; 
  
--  Drop FKey constraint from T_PHASE 
ALTER TABLE T_PHASE DROP CONSTRAINT FK_PHASEMANAGER ; 
  
--  Drop FKey constraint from T_PHASE 
ALTER TABLE T_PHASE DROP CONSTRAINT FK_PHASEPLANER ; 
  
--  Drop FKey constraint from PEDEMO.T_PSN_ONLINE 
ALTER TABLE PEDEMO.T_PSN_ONLINE DROP CONSTRAINT FK_PSNON_DOPSN ; 
  
--  Drop FKey constraint from PEDEMO.T_PSN_ONLINE 
ALTER TABLE PEDEMO.T_PSN_ONLINE DROP CONSTRAINT FK_PSNON_PSN ; 
  
--  Drop FKey constraint from PEDEMO.T_PSN_STATUS 
ALTER TABLE PEDEMO.T_PSN_STATUS DROP CONSTRAINT FK_PSNSTA_DOPSN ; 
  
--  Drop FKey constraint from PEDEMO.T_PSN_STATUS 
ALTER TABLE PEDEMO.T_PSN_STATUS DROP CONSTRAINT FK_PSNSTA_PSN ; 

--  Drop FKey constraint from T_RUNNING_PSN_ONLINE 
ALTER TABLE T_RUNNING_PSN_ONLINE DROP CONSTRAINT FK_PSN_ONLINE_PSN ; 
  
--  Drop FKey constraint from T_RUNNING_DAILY 
ALTER TABLE T_RUNNING_DAILY DROP CONSTRAINT FK_RUNNINGDAILY_DRIVER ; 
  
--  Drop FKey constraint from T_RUNNING_DAILY 
ALTER TABLE T_RUNNING_DAILY DROP CONSTRAINT FK_RUNNINGDAILY_SERVER ; 
  
--  Drop FKey constraint from T_RUNNING_TURN 
ALTER TABLE T_RUNNING_TURN DROP CONSTRAINT FK_RUNTDRIVER ; 
  
--  Drop FKey constraint from T_RUNNING_TURN 
ALTER TABLE T_RUNNING_TURN DROP CONSTRAINT FK_RUNTSERVER ; 
  
--  Drop FKey constraint from T_RUNNING_SHIFTROOM 
ALTER TABLE T_RUNNING_SHIFTROOM DROP CONSTRAINT FK_SHIFTROOM_ATTEMPER ; 
  
--  Drop FKey constraint from T_RUNNING_STATION 
ALTER TABLE T_RUNNING_STATION DROP CONSTRAINT FK_STATION_RESPONSOR ; 
  
--  Drop FKey constraint from T_SUPERVISE 
ALTER TABLE T_SUPERVISE DROP CONSTRAINT FK_SUPERVISESUPPER ; 
  
--  Drop FKey constraint from T_EQUFIT 
ALTER TABLE T_EQUFIT DROP CONSTRAINT FK_TEQUFITCNTER ; 
  
--  Drop FKey constraint from T_EQUIPMENT 
ALTER TABLE T_EQUIPMENT DROP CONSTRAINT FK_TEQUIPMENTEQURSP ; 
  
--  Drop FKey constraint from T_FITTINGS 
ALTER TABLE T_FITTINGS DROP CONSTRAINT FK_TFITRSP ; 
  
--  Drop FKey constraint from T_TKT_BASEIN_H 
ALTER TABLE T_TKT_BASEIN_H DROP CONSTRAINT FK_TKT_BASEIN_H_ACTOR ; 
  
--  Drop FKey constraint from T_TKT_BASEIN_H 
ALTER TABLE T_TKT_BASEIN_H DROP CONSTRAINT FK_TKT_BASEIN_H_DOPSN ; 
  
--  Drop FKey constraint from T_TKT_CENTERIN_H 
ALTER TABLE T_TKT_CENTERIN_H DROP CONSTRAINT FK_TKT_CENTERIN_H_DOPSN ; 
  
--  Drop FKey constraint from T_TKT_CLOSEDAILY 
ALTER TABLE T_TKT_CLOSEDAILY DROP CONSTRAINT FK_TKT_CLOSEDAILY_DOPSN ; 
  
--  Drop FKey constraint from T_TKT_SERVERCHECK 
ALTER TABLE T_TKT_SERVERCHECK DROP CONSTRAINT FK_TKT_SERVERCHECK_DOPSN ; 
  
--  Drop FKey constraint from T_TKT_SERVERCHECK 
ALTER TABLE T_TKT_SERVERCHECK DROP CONSTRAINT FK_TKT_SERVERCHECK_DRIVER ; 
  
--  Drop FKey constraint from T_TKT_SERVERCHECK 
ALTER TABLE T_TKT_SERVERCHECK DROP CONSTRAINT FK_TKT_SERVERCHECK_INPUTER ; 
  
--  Drop FKey constraint from T_TKT_SERVERCHECK 
ALTER TABLE T_TKT_SERVERCHECK DROP CONSTRAINT FK_TKT_SERVERCHECK_REVIEWER ; 
  
--  Drop FKey constraint from T_TKT_SERVERCHECK 
ALTER TABLE T_TKT_SERVERCHECK DROP CONSTRAINT FK_TKT_SERVERCHECK_SERVER ; 
  
--  Drop FKey constraint from T_TKT_SERVERDEL_H 
ALTER TABLE T_TKT_SERVERDEL_H DROP CONSTRAINT FK_TKT_SERVERDEL_H_DOPSN ; 
  
--  Drop FKey constraint from T_TKT_SERVERIN_H 
ALTER TABLE T_TKT_SERVERIN_H DROP CONSTRAINT FK_TKT_SERVERIN_H_ACTOR ; 
  
--  Drop FKey constraint from T_TKT_SERVERIN_H 
ALTER TABLE T_TKT_SERVERIN_H DROP CONSTRAINT FK_TKT_SERVERIN_H_SERVER ; 
  
--  Drop FKey constraint from T_TKT_SERVEROUT_H 
ALTER TABLE T_TKT_SERVEROUT_H DROP CONSTRAINT FK_TKT_SERVEROUT_H_ACTOR ; 
  
--  Drop FKey constraint from T_TKT_SERVEROUT_H 
ALTER TABLE T_TKT_SERVEROUT_H DROP CONSTRAINT FK_TKT_SERVEROUT_H_SERVER ; 
  
--  Drop FKey constraint from T_ONLINE 
ALTER TABLE T_ONLINE DROP CONSTRAINT FK_TONLINEINSTALLER ; 
  
--  Drop FKey constraint from T_ONLINE 
ALTER TABLE T_ONLINE DROP CONSTRAINT FK_TONLINERESPONSOR ; 
  
--  Drop FKey constraint from T_PM_WORKSHEETS 
ALTER TABLE T_PM_WORKSHEETS DROP CONSTRAINT FK_TPM_WORKSHEETGETTERS ; 
  
--  Drop FKey constraint from T_PROJECT 
ALTER TABLE T_PROJECT DROP CONSTRAINT FK_TPROJECTACPTTER ; 
  
--  Drop FKey constraint from T_PROJECT 
ALTER TABLE T_PROJECT DROP CONSTRAINT FK_TPROJECTINITOR ; 
  
--  Drop FKey constraint from T_PROJECT 
ALTER TABLE T_PROJECT DROP CONSTRAINT FK_TPROJECTMANAGER ; 
  
--  Drop FKey constraint from T_PROJECT 
ALTER TABLE T_PROJECT DROP CONSTRAINT FK_TPROJECTPLANACPTTER ; 
  
--  Drop FKey constraint from T_PROJECT 
ALTER TABLE T_PROJECT DROP CONSTRAINT FK_TPROJECTPLANSUPPER ; 
  
--  Drop FKey constraint from T_RUNNING_INCOME 
ALTER TABLE T_RUNNING_INCOME DROP CONSTRAINT FK_TRINCOMEPSN ; 
  
--  Drop FKey constraint from T_RUNNING_ANALYSYS 
ALTER TABLE T_RUNNING_ANALYSYS DROP CONSTRAINT FK_TRUNNINGANALYSYSPSN ; 
  
--  Drop FKey constraint from T_SECURITY_USER 
ALTER TABLE T_SECURITY_USER DROP CONSTRAINT FK_TSECURITY_USERPSNID ; 
  
--  Drop FKey constraint from T_SUP_INDIVIDUAL 
ALTER TABLE T_SUP_INDIVIDUAL DROP CONSTRAINT FK_TSUP_INDIVIDUALPSN ; 
  
--  Drop FKey constraint from T_TRAINING 
ALTER TABLE T_TRAINING DROP CONSTRAINT FK_TTRAININGPSN ; 
  
--  Drop FKey constraint from T_USEUP 
ALTER TABLE T_USEUP DROP CONSTRAINT FK_TUSEUPMANAGER ; 
  
--  Drop FKey constraint from T_WORKSHEET 
ALTER TABLE T_WORKSHEET DROP CONSTRAINT FK_TWORKSHEETGETTER ; 
  
--  Drop FKey constraint from T_WORKSHEET 
ALTER TABLE T_WORKSHEET DROP CONSTRAINT FK_TWORKSHEETINITOR ; 
  
--  Drop FKey constraint from T_WORKSHEET 
ALTER TABLE T_WORKSHEET DROP CONSTRAINT FK_TWORKSHEETSETTLER ; 
  
--  Drop FKey constraint from T_WS_WORK 
ALTER TABLE T_WS_WORK DROP CONSTRAINT FK_TWS_WORKWORKER ; 
  
--  Drop FKey constraint from T_USEUP_ACCDAILY 
ALTER TABLE T_USEUP_ACCDAILY DROP CONSTRAINT FK_UADPERSONAL1 ; 
  
--  Drop FKey constraint from T_USEUP_ACCDAILY 
ALTER TABLE T_USEUP_ACCDAILY DROP CONSTRAINT FK_UADPERSONAL2 ; 
  
--  Drop FKey constraint from T_USEUP_BASEDAILY 
ALTER TABLE T_USEUP_BASEDAILY DROP CONSTRAINT FK_UBDPERSONAL ; 
  
--  Drop FKey constraint from T_USEUPBASE 
ALTER TABLE T_USEUPBASE DROP CONSTRAINT FK_UBPERSONAL ; 
  
--  Drop FKey constraint from T_USEUP_TMPDAILY 
ALTER TABLE T_USEUP_TMPDAILY DROP CONSTRAINT FK_UTDAILYBASEPSN ; 
  
--  Drop FKey constraint from T_USEUP_TMPDAILY 
ALTER TABLE T_USEUP_TMPDAILY DROP CONSTRAINT FK_UTDAILYCONPSN ; 
  
--  Drop FKey constraint from T_USEUP_TMPDAILY 
ALTER TABLE T_USEUP_TMPDAILY DROP CONSTRAINT FK_UTDAILYUSECHECK ; 
  
--  Drop FKey constraint from T_USEUP_TMPDAILY 
ALTER TABLE T_USEUP_TMPDAILY DROP CONSTRAINT FK_UTDAILYUSEPSN ; 
  
--  Drop FKey constraint from T_USEUP_WATING 
ALTER TABLE T_USEUP_WATING DROP CONSTRAINT FK_UWTDOPSN ; 
  
--  Drop FKey constraint from T_USEUP_WATING 
ALTER TABLE T_USEUP_WATING DROP CONSTRAINT FK_UWTINPUTER ; 
  
--  Drop FKey constraint from T_WS_WATING 
ALTER TABLE T_WS_WATING DROP CONSTRAINT FK_WSWTPERSONAL ; 
  

-- Drop all user named constraints
ALTER TABLE T_PERSONAL_X DROP CONSTRAINT FK_PSNBUS ;
ALTER TABLE T_PERSONAL_X DROP CONSTRAINT FK_PSNLINE ;
ALTER TABLE T_PERSONAL_X DROP CONSTRAINT FK_TPERSONALBRANCH ;
ALTER TABLE T_PERSONAL_X DROP CONSTRAINT FK_PERSONAL_DEPT ;
ALTER TABLE T_PERSONAL_X DROP CONSTRAINT PK_PERSONAL ;

--  Recreate original table 
CREATE TABLE T_PERSONAL
(
  C_BELONG                NUMBER(18)            NOT NULL,
  C_PERSONALID            NUMBER(18)            NOT NULL,
  C_WORKERID              VARCHAR2(40 BYTE)     NOT NULL,
  C_PERSONALNAME          VARCHAR2(40 BYTE)     NOT NULL,
  C_PID                   VARCHAR2(255 BYTE),
  C_SEX                   VARCHAR2(5 BYTE),
  C_PEOPLE                VARCHAR2(20 BYTE),
  C_NATIVEPLACE           VARCHAR2(20 BYTE),
  C_REGADDRESS            VARCHAR2(50 BYTE),
  C_BARTHDAY              DATE,
  C_MARRYSTATE            VARCHAR2(4 BYTE),
  C_ANNUITIES             VARCHAR2(20 BYTE),
  C_ACCUMULATION          VARCHAR2(20 BYTE),
  C_PERSONALONDATE        DATE                  NOT NULL,
  C_PERSONALCURRENTSTATE  NUMBER(3)             NOT NULL,
  C_PERSONALDOWNDATE      DATE                  NOT NULL,
  C_DOWNREASON            VARCHAR2(128 BYTE),
  C_UPGRADE_DATE          DATE,
  C_UPGRADE_REASON        VARCHAR2(128 BYTE),
  C_TYPE                  VARCHAR2(10 BYTE)     NOT NULL,
  C_POSITION              VARCHAR2(1 BYTE),
  C_REGBELONG             VARCHAR2(20 BYTE),
  C_PARTY                 VARCHAR2(12 BYTE),
  C_GRADE                 VARCHAR2(40 BYTE),
  C_SCHOOLHISTORY         VARCHAR2(60 BYTE),
  C_ALLOTDATE             DATE,
  C_ALLOTREASON           VARCHAR2(128 BYTE),
  C_DEPART                NUMBER(18)            NOT NULL,
  C_OFFICE                VARCHAR2(40 BYTE),
  C_LINEID                NUMBER(18),
  C_BUSID                 NUMBER(18),
  C_FILLTABLEDATE         DATE,
  C_COMMEND               VARCHAR2(20 BYTE),
  C_WORKDATE              DATE,
  C_RETIREDATE            DATE,
  C_LENGTHSERVICE         VARCHAR2(3 BYTE),
  C_INDATE                DATE,
  C_OUTDATE               DATE,
  C_WORKLENGTH            VARCHAR2(3 BYTE),
  C_GROUPNO               VARCHAR2(16 BYTE),
  C_CONTRACTNO            VARCHAR2(20 BYTE),
  C_CONTR1_FROM           DATE,
  C_CONTR1_END            DATE,
  C_CONTRACTREASON        VARCHAR2(128 BYTE),
  C_CONTR2_FROM           DATE,
  C_CONTR2_END            DATE,
  C_WORKTYPE              VARCHAR2(10 BYTE),
  C_LEVEL                 NUMBER(3),
  C_TECHLEVEL             VARCHAR2(40 BYTE),
  C_RESPONSIBILITY        VARCHAR2(400 BYTE),
  C_CERT1_NO              VARCHAR2(16 BYTE),
  C_CERT1_NO_DATE         DATE,
  C_CERT2_NO              VARCHAR2(16 BYTE),
  C_CERT2_NO_HEX          VARCHAR2(16 BYTE),
  C_SERVICENO             VARCHAR2(20 BYTE),
  C_SERVICENO_DATE        DATE,
  C_FRONT_WORKRESUME      VARCHAR2(400 BYTE),
  C_FRONT_TRAININGRESUME  VARCHAR2(400 BYTE),
  C_SPECIFICATION         VARCHAR2(60 BYTE),
  C_DEGREE                VARCHAR2(60 BYTE),
  C_GRADUATE              VARCHAR2(20 BYTE),
  C_SKILL                 VARCHAR2(100 BYTE),
  C_LAN_COM               VARCHAR2(100 BYTE),
  C_NATIONAL              VARCHAR2(40 BYTE),
  C_STATE                 VARCHAR2(20 BYTE),
  C_CITY                  VARCHAR2(30 BYTE),
  C_ADDRESS               VARCHAR2(60 BYTE),
  C_ZIP                   VARCHAR2(10 BYTE),
  C_TELEPNONENO           VARCHAR2(20 BYTE),
  C_EMAIL                 VARCHAR2(60 BYTE),
  C_OFFICETEL             VARCHAR2(40 BYTE),
  C_OFFICEEXT             VARCHAR2(20 BYTE),
  C_OFFICEFAX             VARCHAR2(20 BYTE),
  C_LASTMODIFIER          NUMBER(18),
  C_COMMENT               VARCHAR2(100 BYTE)
)
LOGGING 
NOCACHE
NOPARALLEL
NOMONITORING;
 
--  Copy the data from the renamed table  
INSERT /*+ APPEND */
INTO T_PERSONAL INS_TBL
(C_BELONG, C_PERSONALID, C_WORKERID, C_PERSONALNAME, 
C_PID, C_SEX, C_PEOPLE, C_NATIVEPLACE, 
C_REGADDRESS, C_BARTHDAY, C_MARRYSTATE, C_ANNUITIES, 
C_ACCUMULATION, C_PERSONALONDATE, C_PERSONALCURRENTSTATE, C_PERSONALDOWNDATE, 
C_DOWNREASON, C_UPGRADE_DATE, C_UPGRADE_REASON, C_TYPE, 
C_POSITION, C_REGBELONG, C_PARTY, C_GRADE, 
C_SCHOOLHISTORY, C_ALLOTDATE, C_ALLOTREASON, C_DEPART, 
C_OFFICE, C_LINEID, C_BUSID, C_FILLTABLEDATE, 
C_COMMEND, C_WORKDATE, C_RETIREDATE, C_LENGTHSERVICE, 
C_INDATE, C_OUTDATE, C_WORKLENGTH, C_GROUPNO, 
C_CONTRACTNO, C_CONTR1_FROM, C_CONTR1_END, C_CONTRACTREASON, 
C_CONTR2_FROM, C_CONTR2_END, C_WORKTYPE, C_LEVEL, 
C_TECHLEVEL, C_RESPONSIBILITY, C_CERT1_NO, C_CERT1_NO_DATE, 
C_CERT2_NO, C_CERT2_NO_HEX, C_SERVICENO, C_SERVICENO_DATE, 
C_FRONT_WORKRESUME, C_FRONT_TRAININGRESUME, C_SPECIFICATION, C_DEGREE, 
C_GRADUATE, C_SKILL, C_LAN_COM, C_NATIONAL, 
C_STATE, C_CITY, C_ADDRESS, C_ZIP, 
C_TELEPNONENO, C_EMAIL, C_OFFICETEL, C_OFFICEEXT, 
C_OFFICEFAX, C_LASTMODIFIER, C_COMMENT)
SELECT 
C_BELONG, C_PERSONALID, C_WORKERID, C_PERSONALNAME, 
C_PID, C_SEX, C_PEOPLE, C_NATIVEPLACE, 
C_REGADDRESS, C_BARTHDAY, C_MARRYSTATE, C_ANNUITIES, 
C_ACCUMULATION, C_PERSONALONDATE, C_PERSONALCURRENTSTATE, C_PERSONALDOWNDATE, 
C_DOWNREASON, C_UPGRADE_DATE, C_UPGRADE_REASON, C_TYPE, 
C_POSITION, C_REGBELONG, C_PARTY, C_GRADE, 
C_SCHOOLHISTORY, C_ALLOTDATE, C_ALLOTREASON, C_DEPART, 
C_OFFICE, C_LINEID, C_BUSID, C_FILLTABLEDATE, 
C_COMMEND, C_WORKDATE, C_RETIREDATE, C_LENGTHSERVICE, 
C_INDATE, C_OUTDATE, C_WORKLENGTH, C_GROUPNO, 
C_CONTRACTNO, C_CONTR1_FROM, C_CONTR1_END, C_CONTRACTREASON, 
C_CONTR2_FROM, C_CONTR2_END, C_WORKTYPE, C_LEVEL, 
C_TECHLEVEL, C_RESPONSIBILITY, C_CERT1_NO, C_CERT1_NO_DATE, 
C_CERT2_NO, C_CERT2_NO_HEX, C_SERVICENO, C_SERVICENO_DATE, 
C_FRONT_WORKRESUME, C_FRONT_TRAININGRESUME, C_SPECIFICATION, C_DEGREE, 
C_GRADUATE, C_SKILL, C_LAN_COM, C_NATIONAL, 
C_STATE, C_CITY, C_ADDRESS, C_ZIP, 
C_TELEPNONENO, C_EMAIL, C_OFFICETEL, C_OFFICEEXT, 
C_OFFICEFAX, C_LASTMODIFIER, C_COMMENT
FROM T_PERSONAL_X SEL_TBL ; 
  
Commit ; 
  

-- Drop all other user named indexes 
DROP INDEX IDX_PERSONALWORKERID ;

 
--  DROP the renamed table  
 
DROP TABLE "T_PERSONAL_X" ; 


--  Recreate Indexes, Constraints, and Grants 

CREATE UNIQUE INDEX PK_PERSONAL ON T_PERSONAL
(C_BELONG, C_PERSONALID)
LOGGING
NOPARALLEL
ONLINE;


CREATE UNIQUE INDEX IDX_PERSONALWORKERID ON T_PERSONAL
(C_BELONG, C_WORKERID, C_PERSONALDOWNDATE)
NOLOGGING
NOPARALLEL
ONLINE;


ALTER TABLE T_PERSONAL ADD (
  CONSTRAINT PK_PERSONAL
 PRIMARY KEY
 (C_BELONG,C_PERSONALID)
    USING INDEX);

ALTER TABLE T_PERSONAL ADD (
  CONSTRAINT FK_PERSONAL_DEPT 
 FOREIGN KEY (C_BELONG,C_DEPART) 
 REFERENCES T_DEPARTMENT (C_BELONG,C_DEPARTMENTID));

ALTER TABLE T_PERSONAL ADD (
  CONSTRAINT FK_PSNBUS 
 FOREIGN KEY (C_BELONG,C_BUSID) 
 REFERENCES T_EQUIPMENT (C_BELONG,C_EQUID));

ALTER TABLE T_PERSONAL ADD (
  CONSTRAINT FK_PSNLINE 
 FOREIGN KEY (C_BELONG,C_LINEID) 
 REFERENCES T_RUNNING_LINE (C_BELONG,C_ID));

ALTER TABLE T_PERSONAL ADD (
  CONSTRAINT FK_TPERSONALBRANCH 
 FOREIGN KEY (C_BELONG) 
 REFERENCES T_BRANCH (C_BRANCHID));
 
--  Recreate the FKeys that reference the NEW table 
 
ALTER TABLE T_RUNNING_BUSPARK ADD 
 CONSTRAINT FK_BUSPARK_ATTEMPER
 FOREIGN KEY (C_BELONG, C_ATTEMPER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_DEPARTMENT ADD 
 CONSTRAINT FK_DEPARTMENT_MAN
 FOREIGN KEY (C_BELONG, C_MANAGER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_USEUP_ELE_TMP ADD 
 CONSTRAINT FK_ELETMP_CHCKPSN
 FOREIGN KEY (C_BELONG, C_CHCKPSN) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_USEUP_ELE_TMP ADD 
 CONSTRAINT FK_ELETMP_DOPSN
 FOREIGN KEY (C_BELONG, C_DOPSN) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_USEUP_ELE_TMP ADD 
 CONSTRAINT FK_ELE_INPUTPSN
 FOREIGN KEY (C_BELONG, C_INPUTER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
    
ALTER TABLE T_RUNNING_LINE ADD 
 CONSTRAINT FK_LINE_ATTEMPER
 FOREIGN KEY (C_BELONG, C_ATTEMPER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_RUNNING_LINE ADD 
 CONSTRAINT FK_LINE_RESPONSOR
 FOREIGN KEY (C_BELONG, C_RESPONSOR) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_OILCARD ADD 
 CONSTRAINT FK_OILCARDDRIVER
 FOREIGN KEY (C_BELONG, C_DRIVER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_OILCARD_INPUT ADD 
 CONSTRAINT FK_OILCARDINPUTPERSONAL
 FOREIGN KEY (C_BELONG, C_INPUTER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_OILCARD_OUTPUT ADD 
 CONSTRAINT FK_OILCARDOUTPUTDRIVER
 FOREIGN KEY (C_BELONG, C_DRIVER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_OILCARD_OUTPUT ADD 
 CONSTRAINT FK_OILCARDOUTPUTINPUTER
 FOREIGN KEY (C_BELONG, C_INPUTER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_ONLINE ADD 
 CONSTRAINT FK_ONLINEDOWNINSTALLOR
 FOREIGN KEY (C_BELONG, C_DOWNINSTALLOR) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_PHASE ADD 
 CONSTRAINT FK_PHASEMANAGER
 FOREIGN KEY (C_BELONG, C_MANAGER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_PHASE ADD 
 CONSTRAINT FK_PHASEPLANER
 FOREIGN KEY (C_BELONG, C_PLANER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_RUNNING_PSN_ONLINE ADD 
 CONSTRAINT FK_PSN_ONLINE_PSN
 FOREIGN KEY (C_BELONG, C_PERSONALID) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_RUNNING_DAILY ADD 
 CONSTRAINT FK_RUNNINGDAILY_DRIVER
 FOREIGN KEY (C_BELONG, C_DRIVER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_RUNNING_DAILY ADD 
 CONSTRAINT FK_RUNNINGDAILY_SERVER
 FOREIGN KEY (C_BELONG, C_SERVER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_RUNNING_TURN ADD 
 CONSTRAINT FK_RUNTDRIVER
 FOREIGN KEY (C_BELONG, C_DRIVER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_RUNNING_TURN ADD 
 CONSTRAINT FK_RUNTSERVER
 FOREIGN KEY (C_BELONG, C_SERVER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_RUNNING_SHIFTROOM ADD 
 CONSTRAINT FK_SHIFTROOM_ATTEMPER
 FOREIGN KEY (C_BELONG, C_ATTEMPER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_RUNNING_STATION ADD 
 CONSTRAINT FK_STATION_RESPONSOR
 FOREIGN KEY (C_BELONG, C_RESPONSOR) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_SUPERVISE ADD 
 CONSTRAINT FK_SUPERVISESUPPER
 FOREIGN KEY (C_BELONG, C_SUPERVISOR) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_EQUFIT ADD 
 CONSTRAINT FK_TEQUFITCNTER
 FOREIGN KEY (C_BELONG, C_CONNECTER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_EQUIPMENT ADD 
 CONSTRAINT FK_TEQUIPMENTEQURSP
 FOREIGN KEY (C_BELONG, C_EQURESPONSOR) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_FITTINGS ADD 
 CONSTRAINT FK_TFITRSP
 FOREIGN KEY (C_BELONG, C_FITRESPONSOR) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_TKT_BASEIN_H ADD 
 CONSTRAINT FK_TKT_BASEIN_H_ACTOR
 FOREIGN KEY (C_BELONG, C_CENTERACTOR) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_TKT_BASEIN_H ADD 
 CONSTRAINT FK_TKT_BASEIN_H_DOPSN
 FOREIGN KEY (C_BELONG, C_BASEDOPSN) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_TKT_CENTERIN_H ADD 
 CONSTRAINT FK_TKT_CENTERIN_H_DOPSN
 FOREIGN KEY (C_BELONG, C_DOPSN) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_TKT_CLOSEDAILY ADD 
 CONSTRAINT FK_TKT_CLOSEDAILY_DOPSN
 FOREIGN KEY (C_BELONG, C_DOPSN) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_TKT_SERVERCHECK ADD 
 CONSTRAINT FK_TKT_SERVERCHECK_DOPSN
 FOREIGN KEY (C_BELONG, C_DOPSN) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_TKT_SERVERCHECK ADD 
 CONSTRAINT FK_TKT_SERVERCHECK_DRIVER
 FOREIGN KEY (C_BELONG, C_DRIVER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_TKT_SERVERCHECK ADD 
 CONSTRAINT FK_TKT_SERVERCHECK_INPUTER
 FOREIGN KEY (C_BELONG, C_INPUTER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_TKT_SERVERCHECK ADD 
 CONSTRAINT FK_TKT_SERVERCHECK_REVIEWER
 FOREIGN KEY (C_BELONG, C_REVIEWER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_TKT_SERVERCHECK ADD 
 CONSTRAINT FK_TKT_SERVERCHECK_SERVER
 FOREIGN KEY (C_BELONG, C_SERVER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_TKT_SERVERDEL_H ADD 
 CONSTRAINT FK_TKT_SERVERDEL_H_DOPSN
 FOREIGN KEY (C_BELONG, C_DOPSN) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_TKT_SERVERIN_H ADD 
 CONSTRAINT FK_TKT_SERVERIN_H_ACTOR
 FOREIGN KEY (C_BELONG, C_BASEACTOR) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_TKT_SERVERIN_H ADD 
 CONSTRAINT FK_TKT_SERVERIN_H_SERVER
 FOREIGN KEY (C_BELONG, C_SERVER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_TKT_SERVEROUT_H ADD 
 CONSTRAINT FK_TKT_SERVEROUT_H_ACTOR
 FOREIGN KEY (C_BELONG, C_BASEACTOR) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_TKT_SERVEROUT_H ADD 
 CONSTRAINT FK_TKT_SERVEROUT_H_SERVER
 FOREIGN KEY (C_BELONG, C_SERVER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_ONLINE ADD 
 CONSTRAINT FK_TONLINEINSTALLER
 FOREIGN KEY (C_BELONG, C_ONLINEINSTALLER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_ONLINE ADD 
 CONSTRAINT FK_TONLINERESPONSOR
 FOREIGN KEY (C_BELONG, C_ONLINERESPONSOR) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_PM_WORKSHEETS ADD 
 CONSTRAINT FK_TPM_WORKSHEETGETTERS
 FOREIGN KEY (C_BELONG, C_GETTER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_PROJECT ADD 
 CONSTRAINT FK_TPROJECTACPTTER
 FOREIGN KEY (C_BELONG, C_ACCEPTOR) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_PROJECT ADD 
 CONSTRAINT FK_TPROJECTINITOR
 FOREIGN KEY (C_BELONG, C_INITATOR) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_PROJECT ADD 
 CONSTRAINT FK_TPROJECTMANAGER
 FOREIGN KEY (C_BELONG, C_MANAGER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_PROJECT ADD 
 CONSTRAINT FK_TPROJECTPLANACPTTER
 FOREIGN KEY (C_BELONG, C_PLAN_ACCEPTOR) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_PROJECT ADD 
 CONSTRAINT FK_TPROJECTPLANSUPPER
 FOREIGN KEY (C_BELONG, C_PLAN_SUPERVISOR) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_RUNNING_INCOME ADD 
 CONSTRAINT FK_TRINCOMEPSN
 FOREIGN KEY (C_BELONG, C_PSN) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_RUNNING_ANALYSYS ADD 
 CONSTRAINT FK_TRUNNINGANALYSYSPSN
 FOREIGN KEY (C_BELONG, C_PSNID) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_SECURITY_USER ADD 
 CONSTRAINT FK_TSECURITY_USERPSNID
 FOREIGN KEY (C_PSNBELONG, C_PSNID) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_SUP_INDIVIDUAL ADD 
 CONSTRAINT FK_TSUP_INDIVIDUALPSN
 FOREIGN KEY (C_BELONG, C_PSN) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_TRAINING ADD 
 CONSTRAINT FK_TTRAININGPSN
 FOREIGN KEY (C_BELONG, C_ORGINER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_USEUP ADD 
 CONSTRAINT FK_TUSEUPMANAGER
 FOREIGN KEY (C_BELONG, C_MANAGER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_WORKSHEET ADD 
 CONSTRAINT FK_TWORKSHEETGETTER
 FOREIGN KEY (C_BELONG, C_GETTER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_WORKSHEET ADD 
 CONSTRAINT FK_TWORKSHEETINITOR
 FOREIGN KEY (C_BELONG, C_INITATOR) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_WORKSHEET ADD 
 CONSTRAINT FK_TWORKSHEETSETTLER
 FOREIGN KEY (C_BELONG, C_SETTLER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_WS_WORK ADD 
 CONSTRAINT FK_TWS_WORKWORKER
 FOREIGN KEY (C_BELONG, C_WORKER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_USEUP_ACCDAILY ADD 
 CONSTRAINT FK_UADPERSONAL1
 FOREIGN KEY (C_BELONG, C_REVIEWER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_USEUP_ACCDAILY ADD 
 CONSTRAINT FK_UADPERSONAL2
 FOREIGN KEY (C_BELONG, C_ACTOR) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_USEUP_BASEDAILY ADD 
 CONSTRAINT FK_UBDPERSONAL
 FOREIGN KEY (C_BELONG, C_INPUTER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_USEUPBASE ADD 
 CONSTRAINT FK_UBPERSONAL
 FOREIGN KEY (C_BELONG, C_MANAGER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_USEUP_TMPDAILY ADD 
 CONSTRAINT FK_UTDAILYBASEPSN
 FOREIGN KEY (C_BELONG, C_BASEPSN) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_USEUP_TMPDAILY ADD 
 CONSTRAINT FK_UTDAILYCONPSN
 FOREIGN KEY (C_BELONG, C_CONPSN) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_USEUP_TMPDAILY ADD 
 CONSTRAINT FK_UTDAILYUSECHECK
 FOREIGN KEY (C_BELONG, C_USECHECK) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_USEUP_TMPDAILY ADD 
 CONSTRAINT FK_UTDAILYUSEPSN
 FOREIGN KEY (C_BELONG, C_USEPSN) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_USEUP_WATING ADD 
 CONSTRAINT FK_UWTDOPSN
 FOREIGN KEY (C_BELONG, C_DOPSN) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_USEUP_WATING ADD 
 CONSTRAINT FK_UWTINPUTER
 FOREIGN KEY (C_BELONG, C_INPUTER) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
ALTER TABLE T_WS_WATING ADD 
 CONSTRAINT FK_WSWTPERSONAL
 FOREIGN KEY (C_BELONG, C_OPERATOR) 
  REFERENCES T_PERSONAL (C_BELONG, C_PERSONALID)  ; 
  
 
--  Recompile any dependent objects 
 
ALTER FUNCTION "FUN_GET_WS_STRING" COMPILE ; 
  
ALTER PROCEDURE "GENERATE_PM_WORKSHEETS" COMPILE ; 
  
ALTER PROCEDURE "SP_FITTING_ADD" COMPILE ; 
  
ALTER PROCEDURE "SP_FITTING_INSTALL" COMPILE ; 
  
ALTER PROCEDURE "SP_FITTING_OUTDATE" COMPILE ; 
  
ALTER PROCEDURE "SP_FITTING_REPAIR" COMPILE ; 
  
ALTER PROCEDURE "SP_FITTING_TADDRESS" COMPILE ; 
  
ALTER PROCEDURE "SP_FITTING_TSTATUS" COMPILE ; 
  
ALTER PROCEDURE "SP_FITTING_UNINSTALL" COMPILE ; 
  
ALTER PROCEDURE "SP_TKT_CLOSE" COMPILE ; 
  
ALTER PROCEDURE "SP_TKT_COMPLETE_CHECK" COMPILE ; 
  
ALTER PROCEDURE "SP_TKT_PSNBALANCE" COMPILE ; 
  
ALTER PROCEDURE "SP_USEUP_TMPDAILY" COMPILE ; 
  
ALTER VIEW "V_RP_ONLINE" COMPILE ; 
  
--  Rebuild triggers for the new table. 
CREATE OR REPLACE TRIGGER TRG_PERSONALID
BEFORE INSERT ON T_PERSONAL
FOR EACH ROW
DECLARE NEXT_ID NUMBER;
BEGIN
 SELECT SEQ_PERSONAL.NEXTVAL INTO NEXT_ID
 FROM T_SEQFRO;
 :NEW.C_PERSONALID := NEXT_ID;
END;
/
SHOW ERRORS;



CREATE OR REPLACE TRIGGER TRG_PERSONAL_ONLINE
  AFTER INSERT OR UPDATE OF C_ALLOTDATE, C_ALLOTREASON, C_DEPART, C_OFFICE, C_LINEID, C_BUSID ON T_PERSONAL
  FOR EACH ROW
DECLARE
  PSN_ID            NUMBER(18);
  N_ALLOTDATE       DATE;
  N_ALLOTREASON     VARCHAR2(128);
	N_DEPART          NUMBER(18);
	N_OFFICE          VARCHAR2(40);
	N_LINEID          NUMBER(18);
	N_BUSID           NUMBER(18);
	N_ALLOTER         NUMBER(18);
	TODAY             DATE;
BEGIN
--1.读取操作后的新记录值
  PSN_ID            := :NEW.C_PERSONALID;
	N_ALLOTDATE       := :NEW.C_ALLOTDATE;
	N_ALLOTREASON     := :NEW.C_ALLOTREASON;
	N_DEPART          := :NEW.C_DEPART;
	N_OFFICE          := :NEW.C_OFFICE;
	N_LINEID          := :NEW.C_LINEID;
	N_BUSID           := :NEW.C_BUSID;
	N_ALLOTER         := :NEW.C_LASTMODIFIER;
	TODAY             := SYSDATE;

--2.删除当前sysdate后有效的记录
	DELETE FROM T_PSN_ONLINE 
		WHERE C_PERSONALID = PSN_ID 
			AND C_ONDATE >= TRUNC(TODAY);

--3.修改当前有效时间内的downdate为sysdate-1
  UPDATE T_PSN_ONLINE SET C_DOWNDATE = TRUNC(TODAY - 1) 
		WHERE C_PERSONALID = PSN_ID
			AND C_ONDATE < TODAY
			AND C_DOWNDATE = TO_DATE('9999/12/31', 'YYYY/MM/DD');

--4.插入新的状态变动记录，当天生效
  INSERT INTO T_PSN_ONLINE (
		C_BELONG, 
		C_PERSONALID, 
		C_ALLOTREASON, 
		C_DEPART, 
		C_OFFICE, 
		C_LINEID, 
		C_BUSID, 
		C_ONDATE, 
		C_DOWNDATE, 
		C_ALLOTER)
  VALUES
    (:NEW.C_BELONG,
     PSN_ID,
     N_ALLOTREASON,
     N_DEPART,
		 N_OFFICE,
		 N_LINEID,
		 N_BUSID,
		 TRUNC(TODAY),
		 TO_DATE('9999/12/31', 'YYYY/MM/DD'),
		 N_ALLOTER);

END;
/
SHOW ERRORS;



CREATE OR REPLACE TRIGGER TRG_PERSONAL_STATUS
  AFTER INSERT OR UPDATE OF C_UPGRADE_DATE, C_UPGRADE_REASON, C_TYPE, C_POSITION, C_REGBELONG, C_PARTY, C_GRADE, C_SCHOOLHISTORY ON T_PERSONAL
  FOR EACH ROW
DECLARE
  PSN_ID            NUMBER(18);
  N_UPGRADE_DATE    DATE;
  N_UPGRADE_REASON  VARCHAR2(128);
	N_TYPE            VARCHAR2(10);
	N_POSITION        VARCHAR2(1);
	N_REGBELONG       VARCHAR2(20);
	N_PARTY           VARCHAR2(12);
	N_GRADE           VARCHAR2(40);
	N_SCHOOLHISTORY   VARCHAR2(60);
	N_UPGRADER        NUMBER(18);
	TODAY             DATE;
BEGIN
--1.读取操作后的新记录值
  PSN_ID            := :NEW.C_PERSONALID;
	N_UPGRADE_DATE    := :NEW.C_UPGRADE_DATE;
	N_UPGRADE_REASON  := :NEW.C_UPGRADE_REASON;
  N_TYPE            := :NEW.C_TYPE;
  N_POSITION        := :NEW.C_POSITION;
	N_REGBELONG       := :NEW.C_REGBELONG;
  N_PARTY           := :NEW.C_PARTY;
  N_GRADE           := :NEW.C_GRADE;
  N_SCHOOLHISTORY   := :NEW.C_SCHOOLHISTORY;
	N_UPGRADER        := :NEW.C_LASTMODIFIER;
	TODAY             := SYSDATE;

--2.删除当前sysdate后有效的记录
	DELETE FROM T_PSN_STATUS 
		WHERE C_PERSONALID = PSN_ID 
			AND C_ONDATE >= TRUNC(TODAY);

--3.修改当前有效时间内的downdate为sysdate-1
  UPDATE T_PSN_STATUS SET C_DOWNDATE = TRUNC(TODAY - 1) 
		WHERE C_PERSONALID = PSN_ID
			AND C_ONDATE < TODAY
			AND C_DOWNDATE = TO_DATE('9999/12/31', 'YYYY/MM/DD');

--4.插入新的状态变动记录，当天生效
  INSERT INTO T_PSN_STATUS (
		C_BELONG, 
		C_PERSONALID, 
		C_UPGRADE_REASON, 
		C_TYPE, 
		C_POSITION, 
		C_REGBELONG, 
		C_PARTY, 
		C_GRADE, 
		C_SCHOOLHISTORY, 
		C_ONDATE, 
		C_DOWNDATE, 
		C_UPGRADER)
  VALUES
    (:NEW.C_BELONG,
     PSN_ID,
     N_UPGRADE_REASON,
     N_TYPE,
		 N_POSITION,
		 N_REGBELONG,
		 N_PARTY,
		 N_GRADE,
		 N_SCHOOLHISTORY,
		 TRUNC(TODAY),
		 TO_DATE('9999/12/31', 'YYYY/MM/DD'),
		 N_UPGRADER);

END;
/
SHOW ERRORS;

